<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% if agent_id %}{{ agent_id }}{% else %}NeuroEdge Investments{% endif %}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    /* Search-AI Guide Styles */
    .search-guide {
      margin: 15px 0;
      padding: 15px;
      background: linear-gradient(135deg, #e8f4fd, #d4edda);
      border-radius: 10px;
      border-left: 4px solid #3498db;
      box-shadow: 0 2px 10px rgba(52, 152, 219, 0.2);
    }

    .guide-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      cursor: pointer;
    }

    .guide-title {
      margin: 0;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toggle-btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.8em;
      transition: all 0.3s ease;
    }

    .toggle-btn:hover {
      background: #2980b9;
      transform: scale(1.05);
    }

    .guide-content {
      display: none;
      animation: fadeIn 0.3s ease-in;
    }

    .guide-content.show {
      display: block;
    }

    .search-examples {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }

    .example-category {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .example-category h5 {
      margin: 0 0 10px 0;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .example-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .example-list li {
      padding: 5px 0;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9em;
    }

    .example-list li:last-child {
      border-bottom: none;
    }

    .example-list li:hover {
      background: #f8f9fa;
      padding-left: 5px;
      color: #3498db;
    }

    .quick-tips {
      background: #fff3cd;
      padding: 12px;
      border-radius: 6px;
      margin: 10px 0;
      border-left: 4px solid #ffc107;
    }

    .quick-tips h6 {
      margin: 0 0 8px 0;
      color: #856404;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .tip-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 5px 0;
      font-size: 0.9em;
      color: #856404;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .search-examples {
        grid-template-columns: 1fr;
      }
      
      .search-guide {
        margin: 10px 0;
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="page-wrapper">

    <!-- Header -->
    <header class="main-header">
      <div class="header-left">
        <a href="https://neurodirectory.onrender.com/" class="back-button">← Back to Neuro-Estates</a>
        <select class="language-select" id="language-select" name="language-select" aria-label="Select language">
          <option value="en" {% if lang == 'en' %}selected{% endif %}>English</option>
          <option value="af" {% if lang == 'af' %}selected{% endif %}>Afrikaans</option>
          <option value="de" {% if lang == 'de' %}selected{% endif %}>German</option>
          <option value="ng" {% if lang == 'ng' %}selected{% endif %}>Nigerian</option>
          <option value="zh" {% if lang == 'zh' %}selected{% endif %}>Chinese</option>
          <option value="pt" {% if lang == 'pt' %}selected{% endif %}>Portuguese</option>
        </select>
      </div>

      <div class="header-center">
        <img src="{{ url_for('static', filename='NeuroEdge-logo.png') }}" alt="NeuroEdge-Logo" class="logo">
        <h1 class="site-title">{% if agent_id %}{{ agent_id }}{% else %}NeuroEdge Investments{% endif %}</h1>
        {% if not agent_id %}
          <div class="agent-selector">Select an agent to begin chatting</div>
        {% endif %}
      </div>

      <div class="header-right">
        <button type="button" class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">🌙</button>
      </div>
    </header>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <section id="flashes" role="alert">
          {% for category, msg in messages %}
            <div class="flash-message {{ category }}">{{ msg|safe }}</div>
          {% endfor %}
        </section>
      {% endif %}
    {% endwith %}

    {% if not agent_id %}
      <!-- Search -->
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search agent by name or ID..." autocomplete="off">
        <div id="suggestions" class="suggestions-list"></div>
      </div>

      <!-- Property Buttons -->
      <div class="button-container">
        <a href="https://tally.so/r/w7rkX6" class="custom-button">List a Property</a>
        <a href="/chat/Search-AI" class="custom-button">Search a Property</a>
      </div>

      <!-- Agent Grid -->
      <main class="agent-list" id="agentGrid">
        {% for agent in agents %}
          <a href="{{ url_for('chat', agent_id=agent) }}" class="agent-card">{{ agent }}</a>
        {% endfor %}
      </main>
    {% else %}
      
      <!-- Search-AI Guide (Only for Search-AI agent) -->
      {% if agent_id == 'Search-AI' %}
      <div class="search-guide">
        <div class="guide-header" onclick="toggleSearchGuide()">
          <h4 class="guide-title">💡 Search-AI Guide - Find Your Perfect Property</h4>
          <button class="toggle-btn" id="guideToggle">Show Guide</button>
        </div>
        <div class="guide-content" id="guideContent">
          <p style="margin: 0 0 15px 0; color: #2c3e50;"><strong>Search our database of real properties instantly!</strong></p>
          
          <div class="search-examples">
            <div class="example-category">
              <h5>🏠 By Location</h5>
              <ul class="example-list">
                <li onclick="useExample('apartments in Windhoek')">"apartments in Windhoek"</li>
                <li onclick="useExample('properties in city center')">"properties in city center"</li>
                <li onclick="useExample('houses in Klein Windhoek')">"houses in Klein Windhoek"</li>
                <li onclick="useExample('villas in Ludwigsdorf')">"villas in Ludwigsdorf"</li>
              </ul>
            </div>
            
            <div class="example-category">
              <h5>💰 By Price</h5>
              <ul class="example-list">
                <li onclick="useExample('under 2 million')">"under 2 million"</li>
                <li onclick="useExample('1.5 to 3 million NAD')">"1.5 to 3 million NAD"</li>
                <li onclick="useExample('budget 800,000')">"budget 800,000"</li>
                <li onclick="useExample('properties under 1.5 million')">"properties under 1.5 million"</li>
              </ul>
            </div>
            
            <div class="example-category">
              <h5>🛏️ By Size</h5>
              <ul class="example-list">
                <li onclick="useExample('3 bedroom house')">"3 bedroom house"</li>
                <li onclick="useExample('2 bathroom apartment')">"2 bathroom apartment"</li>
                <li onclick="useExample('4 bedrooms 3 bathrooms')">"4 bedrooms 3 bathrooms"</li>
                <li onclick="useExample('studio apartment')">"studio apartment"</li>
              </ul>
            </div>
            
            <div class="example-category">
              <h5>⭐ By Features</h5>
              <ul class="example-list">
                <li onclick="useExample('property with pool')">"property with pool"</li>
                <li onclick="useExample('apartment with gym')">"apartment with gym"</li>
                <li onclick="useExample('house with garden')">"house with garden"</li>
                <li onclick="useExample('secure parking')">"secure parking"</li>
              </ul>
            </div>
          </div>
          
          <div class="quick-tips">
            <h6>🚀 Pro Search Tips</h6>
            <div class="tip-item">🔍 <strong>Combine terms:</strong> "3 bedroom apartment in Windhoek under 2 million"</div>
            <div class="tip-item">💬 <strong>Chat with agents:</strong> Click "Chat with Agent" to get more details</div>
            <div class="tip-item">🌐 <strong>View listings:</strong> Click "View Property" for external listings</div>
            <div class="tip-item">📱 <strong>Be specific:</strong> The more details, the better the results</div>
          </div>
          
          <div style="text-align: center; margin-top: 15px;">
            <button onclick="hideGuidePermanently()" style="background: #95a5a6; color: white; border: none; padding: 5px 15px; border-radius: 15px; cursor: pointer; font-size: 0.8em;">
              Don't show again
            </button>
          </div>
        </div>
      </div>
      {% endif %}

      {% if agent_id != 'Search-AI' %}
      <div class="suggested-questions" id="suggested-questions">
        <h4>💡 Suggested Questions:</h4>
        <div class="suggestion-bubbles">
          <button class="suggestion-bubble" onclick="sendSuggested('What can you help me with exactly?')">What can you help me with exactly?</button>
        </div>
      </div>
      {% endif %}

      <!-- Chat -->
      <main id="chat">
        {% for msg in messages %}
          <article class="message {{ msg.role }}">
            <div class="content">{{ msg.content|safe }}</div>
            {% if msg.timestamp %}<time>{{ msg.timestamp }}</time>{% endif %}
          </article>
        {% endfor %}
        <div id="loading">Loading...</div>
      </main>

      <!-- Navigation - Form button hidden for Search-AI agent -->
      <section class="nav-buttons">
        <a href="{{ url_for('home') }}" class="nav-button">🏠 Home</a>
        
        {% if agent_id != 'Search-AI' %}
          <a href="{{ tally_form if tally_form else '#' }}" class="nav-button" target="_blank">📋 Form</a>
        {% endif %}
        
        <form action="{{ url_for('reset', agent_id=agent_id) }}" method="post">
          <button type="submit" class="nav-button">🔄 Reset Chat</button>
        </form>
      </section>

      {% if current_user.is_authenticated and current_user.role == 'admin' %}
        <div class="upload-container">
          <form method="POST" enctype="multipart/form-data" action="/upload">
            <input type="file" name="rag_file" id="rag_file" hidden onchange="this.form.submit()">
            <label for="rag_file" class="upload-btn">📄 Upload File</label>
          </form>
        </div>
      {% endif %}

      <!-- Chat Input -->
      <form id="chat-form" action="{{ url_for('chat', agent_id=agent_id) }}" method="POST">
        <input type="text" id="user_input" name="user_input" required placeholder="Type your message...">
        <button type="submit" id="submit-btn">Send</button>
      </form>
    {% endif %}
  </div>

  <!-- Scripts -->
  <script>
    // Search-AI Guide Functions
    function toggleSearchGuide() {
      const content = document.getElementById('guideContent');
      const toggleBtn = document.getElementById('guideToggle');
      
      content.classList.toggle('show');
      toggleBtn.textContent = content.classList.contains('show') ? 'Hide Guide' : 'Show Guide';
      
      // Save state to localStorage
      localStorage.setItem('searchGuideVisible', content.classList.contains('show'));
    }

    function useExample(text) {
      document.getElementById('user_input').value = text;
      document.getElementById('user_input').focus();
    }

    function hideGuidePermanently() {
      const guide = document.querySelector('.search-guide');
      guide.style.display = 'none';
      localStorage.setItem('searchGuideHidden', 'true');
    }

    // Initialize guide state on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Check if user has hidden the guide permanently
      if (localStorage.getItem('searchGuideHidden') === 'true') {
        const guide = document.querySelector('.search-guide');
        if (guide) guide.style.display = 'none';
        return;
      }

      // Set initial guide state
      const isGuideVisible = localStorage.getItem('searchGuideVisible') === 'true';
      const content = document.getElementById('guideContent');
      const toggleBtn = document.getElementById('guideToggle');
      
      if (content && toggleBtn) {
        if (isGuideVisible) {
          content.classList.add('show');
          toggleBtn.textContent = 'Hide Guide';
        }
        
        // Auto-hide guide after 30 seconds if not interacted with
        setTimeout(() => {
          if (!content.classList.contains('show')) return;
          
          const now = new Date().getTime();
          const lastInteraction = localStorage.getItem('searchGuideLastInteraction') || 0;
          
          if (now - lastInteraction > 30000) { // 30 seconds
            content.classList.remove('show');
            toggleBtn.textContent = 'Show Guide';
          }
        }, 30000);
      }
    });

    // Track guide interactions
    document.addEventListener('click', function(e) {
      if (e.target.closest('.search-guide')) {
        localStorage.setItem('searchGuideLastInteraction', new Date().getTime());
      }
    });

    // Function to detect and process https links in chat messages
    function processLinksInChat() {
      const messages = document.querySelectorAll('.message .content');

      messages.forEach((message) => {
        // Skip messages that already contain links
        if (message.querySelector('a')) return;

        let html = message.innerHTML;

        // Convert only https URLs to clickable "View Property" button
        // Excludes trailing punctuation or parentheses
        html = html.replace(
          /(https:\/\/[^\s<")]+)/gi,
          '<a href="$1" target="_blank" rel="noopener" class="property-link">View Property</a>'
        );

        message.innerHTML = html;
      });
    }

    // Observe chat container for new messages and process links
    function observeChatChanges() {
      const chatContainer = document.getElementById('chat');
      if (!chatContainer) return;

      // Process existing messages initially
      processLinksInChat();

      // Set up a MutationObserver to handle newly added messages
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.addedNodes.length) {
            processLinksInChat();
          }
        });
      });

      observer.observe(chatContainer, { childList: true, subtree: true });
    }

    // Initialize link processing when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      observeChatChanges();
    });

    // Theme toggle
    (() => {
      const themeToggle = document.getElementById('theme-toggle');
      const body = document.body;
      function setTheme(theme) {
        body.setAttribute('data-theme', theme);
        themeToggle.textContent = theme === 'dark' ? '☀️ Light Mode' : '🌙 Dark Mode';
        localStorage.setItem('theme', theme);
      }
      setTheme(localStorage.getItem('theme') || 'light');
      themeToggle?.addEventListener('click', () => {
        setTheme(body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
      });
    })();

    // Suggested Qs
    function sendSuggested(text) {
      document.getElementById('user_input').value = text;
      document.getElementById('chat-form').submit();
    }

    // Search functionality with auto-suggestions
    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('searchInput');
      const suggestionsList = document.getElementById('suggestions');
      const agentGrid = document.getElementById('agentGrid');
      
      // Get all agent cards
      const agentCards = agentGrid ? Array.from(agentGrid.getElementsByClassName('agent-card')) : [];
      const agentNames = agentCards.map(card => card.textContent.trim());
      
      // Filter agents based on search
      function filterAgents(searchText) {
        const searchLower = searchText.toLowerCase();
        
        agentCards.forEach(card => {
          const agentName = card.textContent.trim().toLowerCase();
          if (agentName.includes(searchLower)) {
            card.style.display = 'block';
          } else {
            card.style.display = 'none';
          }
        });
      }
      
      // Display suggestions in the dropdown
      function displaySuggestions(suggestions) {
        suggestionsList.innerHTML = '';
        
        if (suggestions.length === 0) {
          suggestionsList.style.display = 'none';
          return;
        }
        
        suggestions.forEach(suggestion => {
          const div = document.createElement('div');
          div.className = 'suggestion-item';
          div.textContent = suggestion;
          div.addEventListener('click', function() {
            searchInput.value = suggestion;
            filterAgents(suggestion);
            suggestionsList.style.display = 'none';
            
            // Find and highlight the agent card
            const targetCard = agentCards.find(card => 
              card.textContent.trim() === suggestion
            );
            
            if (targetCard) {
              // Remove any existing highlights
              agentCards.forEach(card => card.classList.remove('highlighted'));
              
              // Add highlight to the target card
              targetCard.classList.add('highlighted');
              
              // Scroll to the card
              targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
              
              // Remove highlight after 3 seconds
              setTimeout(() => {
                targetCard.classList.remove('highlighted');
              }, 3000);
            }
          });
          suggestionsList.appendChild(div);
        });
        
        suggestionsList.style.display = 'flex';
      }
      
      if (searchInput && suggestionsList) {
        // Show suggestions when user starts typing
        searchInput.addEventListener('input', function() {
          const searchText = this.value.toLowerCase();
          
          if (searchText.length === 0) {
            suggestionsList.style.display = 'none';
            // Show all agents if search is empty
            agentCards.forEach(card => {
              card.style.display = 'block';
              card.classList.remove('highlighted');
            });
            return;
          }
          
          const filteredSuggestions = agentNames.filter(name => 
            name.toLowerCase().includes(searchText)
            );
          
          displaySuggestions(filteredSuggestions);
          filterAgents(searchText);
        });
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
          if (e.target !== searchInput && !suggestionsList.contains(e.target)) {
            suggestionsList.style.display = 'none';
          }
        });
        
        // Show suggestions when input is focused and has text
        searchInput.addEventListener('focus', function() {
          if (this.value.length > 0) {
            const searchText = this.value.toLowerCase();
            const filteredSuggestions = agentNames.filter(name => 
              name.toLowerCase().includes(searchText)
            );
            displaySuggestions(filteredSuggestions);
          }
        });
      }
    });
  </script>
</body>
</html>