<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% if agent_id %}{{ agent_id }}{% else %}NeuroEdge Investments{% endif %}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
  <div class="page-wrapper">

    <!-- Header -->
    <header class="main-header">
      <div class="header-left">
        <a href="/" class="back-button">â† Back to Neuro-Estates</a>
        <select class="language-select" id="language-select" name="language-select" aria-label="Select language">
          <option value="en" {% if lang == 'en' %}selected{% endif %}>English</option>
          <option value="af" {% if lang == 'af' %}selected{% endif %}>Afrikaans</option>
          <option value="de" {% if lang == 'de' %}selected{% endif %}>German</option>
          <option value="ng" {% if lang == 'ng' %}selected{% endif %}>Nigerian</option>
          <option value="zh" {% if lang == 'zh' %}selected{% endif %}>Chinese</option>
          <option value="pt" {% if lang == 'pt' %}selected{% endif %}>Portuguese</option>
        </select>
      </div>

      <div class="header-center">
        <img src="{{ url_for('static', filename='NeuroEdge-logo.png') }}" alt="NeuroEdge Logo" class="logo">
        <h1 class="site-title">{% if agent_id %}{{ agent_id }}{% else %}NeuroEdge Investments{% endif %}</h1>
        {% if not agent_id %}
          <div class="agent-selector">Select an agent to begin chatting</div>
        {% endif %}
      </div>

      <div class="header-right">
        <button type="button" class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">ğŸŒ™</button>
      </div>
    </header>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <section id="flashes" role="alert">
          {% for category, msg in messages %}
            <div class="flash-message {{ category }}">{{ msg|safe }}</div>
          {% endfor %}
        </section>
      {% endif %}
    {% endwith %}

    {% if not agent_id %}
      <!-- Search -->
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search agent by name or ID..." autocomplete="off">
        <div id="suggestions" class="suggestions-list"></div>
      </div>

      <!-- Property Buttons -->
      <div class="button-container">
        <a href="https://tally.so/r/w7rkX6" class="custom-button">List a Property</a>
        <a href="/chat/Search-AI" class="custom-button">Search a Property</a>
      </div>

      <!-- Agent Grid -->
      <main class="agent-list" id="agentGrid">
        {% for agent in agents %}
          <a href="{{ url_for('chat', agent_id=agent) }}" class="agent-card">{{ agent }}</a>
        {% endfor %}
      </main>
    {% else %}
      {% if messages|length == 0 %}
        <div class="suggested-questions" id="suggested-questions">
          <h4>ğŸ’¡ Suggested Questions:</h4>
          <div class="suggestion-bubbles">
            <button onclick="sendSuggested('What can you help me with exactly?')">What can you help me with exactly?</button>
            <button onclick="sendSuggested('How do I list a Property?')">How do I list a Property?</button>
          </div>
        </div>
      {% endif %}

      <!-- Chat -->
      <main id="chat">
        {% for msg in messages %}
          <article class="message {{ msg.role }}">
            <div class="content">{{ msg.content|safe }}</div>
            {% if msg.timestamp %}<time>{{ msg.timestamp }}</time>{% endif %}
          </article>
        {% endfor %}
        <div id="loading">Loading...</div>
      </main>

      <!-- Navigation -->
      <section class="nav-buttons">
        <a href="{{ url_for('home') }}" class="nav-button">ğŸ  Home</a>
        <a href="{{ tally_form if tally_form else '#' }}" class="nav-button" target="_blank">ğŸ“‹ Contact Form</a>
        <form action="{{ url_for('reset', agent_id=agent_id) }}" method="post">
          <button type="submit" class="nav-button">ğŸ”„ Reset Chat</button>
        </form>
      </section>

      {% if current_user.is_authenticated and current_user.role == 'admin' %}
        <div class="upload-container">
          <form method="POST" enctype="multipart/form-data" action="/upload">
            <input type="file" name="rag_file" id="rag_file" hidden onchange="this.form.submit()">
            <label for="rag_file" class="upload-btn">ğŸ“„ Upload File</label>
          </form>
        </div>
      {% endif %}

      <!-- Chat Input -->
      <form id="chat-form" action="{{ url_for('chat', agent_id=agent_id) }}" method="POST">
        <input type="text" id="user_input" name="user_input" required placeholder="Type your message...">
        <button type="submit" id="submit-btn">Send</button>
      </form>
    {% endif %}
  </div>

  <!-- Scripts -->
  <script>
    // Theme toggle
    (() => {
      const themeToggle = document.getElementById('theme-toggle');
      const body = document.body;
      function setTheme(theme) {
        body.setAttribute('data-theme', theme);
        themeToggle.textContent = theme === 'dark' ? 'â˜€ï¸ Light Mode' : 'ğŸŒ™ Dark Mode';
        localStorage.setItem('theme', theme);
      }
      setTheme(localStorage.getItem('theme') || 'light');
      themeToggle?.addEventListener('click', () => {
        setTheme(body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
      });
    })();

    // Suggested Qs
    function sendSuggested(text) {
      document.getElementById('user_input').value = text;
      document.getElementById('chat-form').submit();
    }

    // Search functionality with auto-suggestions
    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('searchInput');
      const suggestionsList = document.getElementById('suggestions');
      const agentGrid = document.getElementById('agentGrid');
      
      // Get all agent cards
      const agentCards = agentGrid ? Array.from(agentGrid.getElementsByClassName('agent-card')) : [];
      const agentNames = agentCards.map(card => card.textContent.trim());
      
      if (searchInput && suggestionsList) {
        // Show suggestions when input is focused
        searchInput.addEventListener('focus', function() {
          showAllSuggestions();
        });
        
        // Filter suggestions based on input
        searchInput.addEventListener('input', function() {
          const searchText = this.value.toLowerCase();
          
          if (searchText.length === 0) {
            showAllSuggestions();
            return;
          }
          
          const filteredSuggestions = agentNames.filter(name => 
            name.toLowerCase().includes(searchText)
          );
          
          displaySuggestions(filteredSuggestions);
        });
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
          if (e.target !== searchInput && !suggestionsList.contains(e.target)) {
            suggestionsList.style.display = 'none';
          }
        });
        
        // Show all agents when search is cleared
        function showAllSuggestions() {
          displaySuggestions(agentNames);
        }
        
        // Display suggestions in the dropdown
        function displaySuggestions(suggestions) {
          suggestionsList.innerHTML = '';
          
          if (suggestions.length === 0) {
            suggestionsList.style.display = 'none';
            return;
          }
          
          suggestions.forEach(suggestion => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.textContent = suggestion;
            div.addEventListener('click', function() {
              searchInput.value = suggestion;
              filterAgents(suggestion);
              suggestionsList.style.display = 'none';
            });
            suggestionsList.appendChild(div);
          });
          
          suggestionsList.style.display = 'block';
        }
        
        // Filter agents based on search
        function filterAgents(searchText) {
          const searchLower = searchText.toLowerCase();
          
          agentCards.forEach(card => {
            const agentName = card.textContent.trim().toLowerCase();
            if (agentName.includes(searchLower)) {
              card.style.display = 'block';
            } else {
              card.style.display = 'none';
            }
          });
        }
        
        // Initially show all suggestions
        showAllSuggestions();
      }
    });
  </script>
</body>
</html>